<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ORIZONUP - Chat Legal AI</title>
    <!-- Tailwind CSS v4 CDN -->
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Animaci√≥n de entrada de mensajes */
        .message-enter { animation: slideUp 0.3s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar personalizada oscura */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Estilo de escritura (...) */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-slate-950/80 backdrop-blur-md border-b border-slate-800 p-4 fixed w-full top-0 z-50 flex items-center justify-center shadow-lg">
        <div class="text-center">
            <h1 class="text-lg font-bold tracking-tight text-white flex items-center gap-2">
                <i class="fas fa-robot text-blue-500"></i> ORIZONUP AI
            </h1>
            <p class="text-[10px] text-slate-400 uppercase tracking-widest font-semibold">Asistente Legal Virtual</p>
        </div>
    </header>

    <!-- √ÅREA DEL CHAT -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 pt-24 pb-32 space-y-6 scroll-smooth">
        <!-- Los mensajes se inyectan aqu√≠ con JS -->
    </main>

    <!-- INPUT AREA -->
    <div class="fixed bottom-0 w-full bg-slate-950 border-t border-slate-800 p-4 pb-6">
        <div class="max-w-3xl mx-auto relative">
            <input type="text" id="user-input" 
                class="w-full bg-slate-800 text-white border border-slate-700 rounded-xl py-4 pl-5 pr-14 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-slate-500 transition-all shadow-xl"
                placeholder="Escribe tu respuesta aqu√≠..." autocomplete="off">
            
            <button id="send-btn" 
                class="absolute right-2 top-2 bottom-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 transition-colors cursor-pointer flex items-center justify-center">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="text-center mt-2">
            <p class="text-xs text-slate-600">Powered by Cloudflare Workers & Google Gemini</p>
        </div>
    </div>

    <!-- L√ìGICA JAVASCRIPT -->
    <script>
        // üîπ URL DE TU WORKER (BACKEND)
        const WORKER_URL = 'https://long-surf-1df4.frankwilsonknow.workers.dev/';

        // Estado de la conversaci√≥n
        let step = 0;
        let userData = {
            nombre: '',
            empresa: '',
            socios: '',
            capital: '',
            descripcion: ''
        };

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        // INICIO AUTOM√ÅTICO
        window.onload = () => {
            userInput.focus();
            addBotMessage("¬°Hola! Soy OrizonBot ü§ñ. Estoy conectado a la nube para ayudarte a formalizar tu empresa.");
            setTimeout(() => {
                addBotMessage("¬øCu√°l es tu nombre completo?");
            }, 800);
        };

        // EVENTOS (Click y Enter)
        sendBtn.addEventListener('click', handleUserResponse);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleUserResponse();
        });

        function handleUserResponse() {
            const text = userInput.value.trim();
            if (!text) return;

            // Mostrar mensaje usuario
            addUserMessage(text);
            userInput.value = '';
            
            // Procesar l√≥gica seg√∫n el paso actual
            processStep(text);
        }

        function processStep(text) {
            showTyping(); // Mostrar "Escribiendo..."

            // Simular "pensamiento" breve antes de responder
            setTimeout(() => {
                hideTyping();
                
                switch(step) {
                    case 0: // Nombre
                        userData.nombre = text;
                        addBotMessage(`Un gusto, <strong>${text}</strong>. ¬øQu√© nombre tienes pensado para tu empresa?`);
                        step++;
                        break;
                    
                    case 1: // Empresa
                        userData.empresa = text;
                        addBotMessage(`¬°Suena bien "<strong>${text}</strong>"! Ahora, ¬øcu√°ntos socios ser√°n en total? (Incluy√©ndote a ti)`);
                        step++;
                        break;

                    case 2: // Socios
                        if (isNaN(text) || parseInt(text) < 1) {
                            addBotMessage("‚ö†Ô∏è Por favor ingresa un n√∫mero v√°lido de socios (m√≠nimo 1).");
                            return;
                        }
                        userData.socios = text;
                        addBotMessage("Entendido. ¬øCu√°l es el capital inicial en soles? (Solo n√∫meros, ej: 5000)");
                        step++;
                        break;

                    case 3: // Capital
                         if (isNaN(text)) {
                            addBotMessage("‚ö†Ô∏è Por favor ingresa solo n√∫meros para el capital.");
                            return;
                        }
                        userData.capital = text;
                        addBotMessage("√öltima pregunta: Describe brevemente a qu√© se dedicar√° el negocio. üè≠");
                        step++;
                        break;

                    case 4: // Descripci√≥n -> LLAMAR WORKER
                        userData.descripcion = text;
                        addBotMessage("¬°Perfecto! Enviando tus datos a nuestro servidor seguro... ‚òÅÔ∏è");
                        callBackend(); // <--- AQU√ç SE CONECTA AL WORKER
                        step++;
                        break;
                    
                    case 5:
                        addBotMessage("El proceso ha finalizado. Recarga la p√°gina para empezar de nuevo.");
                        break;
                }
            }, 600); 
        }

        // üîπ CONEXI√ìN AL BACKEND (WORKER)
        async function callBackend() {
            showTyping();

            try {
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json(); // Respuesta del Worker (Gemini)

                if (!response.ok) throw new Error(data.error || 'Error desconocido');

                hideTyping();

                // 1. Mostrar An√°lisis
                addBotMessage(`‚úÖ <strong>An√°lisis Completado:</strong><br><br>${data.explicacion}<br><br>Te recomiendo: <strong>${data.tipo_empresa}</strong> bajo el <strong>${data.regimen_tributario}</strong>.`);

                // 2. Mostrar Documento (Minuta) con retardo
                setTimeout(() => {
                    renderDocument(data);
                }, 1500);

            } catch (error) {
                console.error(error);
                hideTyping();
                addErrorMessage(`Error conectando al servidor: ${error.message}`);
                step = 4; // Permitir reintentar
            }
        }

        // RENDERIZAR LA MINUTA (Estilo Papel)
        function renderDocument(data) {
            const fecha = new Date().toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' });
            let siglas = data.tipo_empresa.includes("EIRL") ? "E.I.R.L." : "S.A.C.";

            const docHTML = `
                <div class="relative bg-white text-slate-900 p-8 rounded-sm shadow-2xl font-serif text-sm md:text-base leading-relaxed border border-slate-300 transform rotate-1 transition hover:rotate-0 duration-300">
                    <div class="absolute top-0 left-0 w-full h-2 bg-blue-600/20"></div>
                    
                    <h3 class="text-center font-bold text-lg mb-4 underline">MINUTA DE CONSTITUCI√ìN</h3>
                    
                    <p class="mb-4"><strong>SE√ëOR NOTARIO:</strong><br>
                    S√çRVASE EXTENDER EN SU REGISTRO DE ESCRITURAS P√öBLICAS, LA CONSTITUCI√ìN DE LA EMPRESA <strong>"${userData.empresa.toUpperCase()} ${siglas}"</strong>.</p>
                    
                    <p class="mb-4"><strong>OTORGANTES:</strong><br>
                    ${userData.nombre.toUpperCase()}, PERUANO, CON DNI [___], 
                    ${parseInt(userData.socios) > 1 ? `Y OTROS ${parseInt(userData.socios)-1} SOCIOS,` : 'EN CALIDAD DE TITULAR,'}
                    CON DOMICILIO EN LIMA.</p>

                    <p class="mb-4"><strong>PRIMERO (CAPITAL):</strong><br>
                    EL CAPITAL SOCIAL ES DE <strong>S/ ${userData.capital}</strong>.</p>

                    <p class="mb-4 bg-yellow-50 p-2 border-l-2 border-yellow-400"><strong>SEGUNDO (OBJETO SOCIAL - IA):</strong><br>
                    <em>${data.objeto_social}</em></p>

                    <p class="mb-8"><strong>TERCERO (R√âGIMEN):</strong><br>
                    LA EMPRESA SE ACOGE AL <strong>${data.regimen_tributario.toUpperCase()}</strong>.</p>

                    <p class="text-right mb-12">Lima, ${fecha}</p>
                    
                    <div class="border-t border-black w-48 mx-auto text-center pt-2 text-xs font-bold">
                        Firma Digital OrizonUp
                    </div>
                </div>
                
                <div class="mt-4 flex justify-center">
                    <button class="bg-emerald-600 hover:bg-emerald-500 text-white py-2 px-6 rounded-full font-bold shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fas fa-file-signature"></i> Enviar a Notar√≠a
                    </button>
                </div>
            `;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-3 max-w-3xl mx-auto w-full message-enter';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 mt-1">
                    <i class="fas fa-file-contract text-xs text-white"></i>
                </div>
                <div class="w-full max-w-[90%] md:max-w-[80%]">
                    ${docHTML}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        // --- FUNCIONES UI AUXILIARES ---

        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 max-w-3xl mx-auto w-full flex-row-reverse message-enter';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center shrink-0 mt-1">
                    <i class="fas fa-user text-xs text-slate-300"></i>
                </div>
                <div class="bg-blue-600 text-white px-5 py-3 rounded-2xl rounded-tr-sm shadow-md max-w-[80%]">
                    <p class="text-sm md:text-base">${text}</p>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addBotMessage(htmlText) {
            const div = document.createElement('div');
            div.className = 'flex gap-3 max-w-3xl mx-auto w-full message-enter';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 mt-1 shadow-lg shadow-blue-900/50">
                    <i class="fas fa-robot text-xs text-white"></i>
                </div>
                <div class="bg-slate-800 text-slate-200 px-5 py-3 rounded-2xl rounded-tl-sm shadow-md border border-slate-700 max-w-[80%]">
                    <p class="text-sm md:text-base leading-relaxed">${htmlText}</p>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function addErrorMessage(text) {
             const div = document.createElement('div');
            div.className = 'flex gap-3 max-w-3xl mx-auto w-full message-enter';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-red-600 flex items-center justify-center shrink-0 mt-1">
                    <i class="fas fa-exclamation text-xs text-white"></i>
                </div>
                <div class="bg-red-900/30 text-red-200 px-5 py-3 rounded-2xl border border-red-800 max-w-[80%]">
                    <p class="text-sm font-bold">Error del Sistema:</p>
                    <p class="text-sm">${text}</p>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function showTyping() {
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex gap-3 max-w-3xl mx-auto w-full message-enter';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center shrink-0 mt-1">
                    <i class="fas fa-robot text-xs text-white"></i>
                </div>
                <div class="bg-slate-800 px-4 py-3 rounded-2xl rounded-tl-sm border border-slate-700 flex items-center gap-1">
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-slate-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.appendChild(div);
            scrollToBottom();
        }

        function hideTyping() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html>
